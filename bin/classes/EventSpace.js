"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const EventLevel_1 = require("./EventLevel");
class EventSpace {
    constructor() {
        this._eventLevel = new EventLevel_1.EventLevel();
        this.receive = (eventName, listener) => {
            this._eventLevel
                .getChildLevel(EventSpace.convertEventNameType(eventName), true)
                .receivers.add(listener);
            return listener;
        };
        this.on = this.receive;
        this.receiveOnce = (eventName, listener) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), true);
            level.receivers.add(function once(data) {
                listener(data);
                level.receivers.delete(once);
            });
            return listener;
        };
        this.once = this.receiveOnce;
        this.cancel = (eventName = [], listener) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined)
                if (listener !== undefined)
                    level.receivers.delete(listener);
                else
                    level.receivers.clear();
        };
        this.off = this.cancel;
        this.cancelDescendants = (eventName = [], includeSelf = true) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (includeSelf)
                    level.receivers.clear();
                level.children.clear();
            }
        };
        this.offDescendants = this.cancelDescendants;
        this.cancelAncestors = (eventName = [], includeSelf = true) => {
            let level = this._eventLevel;
            for (const currentName of EventSpace.convertEventNameType(eventName)) {
                level.receivers.clear();
                const currentLevel = level.children.get(currentName);
                if (currentLevel !== undefined)
                    level = currentLevel;
                else
                    return;
            }
            if (includeSelf)
                level.receivers.clear();
        };
        this.offAncestors = this.cancelAncestors;
        this.trigger = (eventName, data, asynchronous) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined)
                level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
        };
        this.send = this.trigger;
        this.triggerDescendants = (eventName, data, includeSelf = true, asynchronous) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (includeSelf)
                    level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
                function triggerChildren(level) {
                    level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
                    level.children.forEach(triggerChildren);
                }
                level.children.forEach(triggerChildren);
            }
        };
        this.sendDescendants = this.triggerDescendants;
        this.triggerAncestors = (eventName, data, includeSelf = true, asynchronous) => {
            let level = this._eventLevel;
            for (const currentName of EventSpace.convertEventNameType(eventName)) {
                level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
                const currentLevel = level.children.get(currentName);
                if (currentLevel !== undefined)
                    level = currentLevel;
                else
                    return;
            }
            if (includeSelf)
                level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
        };
        this.sendAncestors = this.triggerAncestors;
        this.has = (eventName, listener) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (listener !== undefined)
                    return level.receivers.has(listener);
                else
                    return level.receivers.size > 0;
            }
            else
                return false;
        };
        this.hasDescendants = (eventName, includeSelf = true) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (includeSelf && level.receivers.size > 0)
                    return true;
                function checkChildren(level) {
                    if (level.receivers.size > 0) {
                        return true;
                    }
                    else {
                        for (const item of level.children.values())
                            if (checkChildren(item))
                                return true;
                        return false;
                    }
                }
                for (const item of level.children.values())
                    if (checkChildren(item))
                        return true;
                return false;
            }
            else
                return false;
        };
        this.hasAncestors = (eventName, includeSelf = true) => {
            let level = this._eventLevel;
            for (const currentName of EventSpace.convertEventNameType(eventName)) {
                if (level.receivers.size > 0)
                    return true;
                const currentLevel = level.children.get(currentName);
                if (currentLevel !== undefined)
                    level = currentLevel;
                else
                    return false;
            }
            if (includeSelf)
                return level.receivers.size > 0;
            else
                return false;
        };
    }
    /**
     * 将事件名转换成数组的形式
     * @param eventName 事件名称
     */
    static convertEventNameType(eventName) {
        return Array.isArray(eventName) ? eventName : eventName.split('.');
    }
}
exports.EventSpace = EventSpace;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsYXNzZXMvRXZlbnRTcGFjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLDZDQUEwQztBQUUxQztJQUFBO1FBU3FCLGdCQUFXLEdBQUcsSUFBSSx1QkFBVSxFQUFFLENBQUM7UUFFaEQsWUFBTyxHQUFHLENBQXFCLFNBQTRCLEVBQUUsUUFBVztZQUNwRSxJQUFJLENBQUMsV0FBVztpQkFDWCxhQUFhLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksQ0FBQztpQkFDL0QsU0FBUyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUU3QixNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ3BCLENBQUMsQ0FBQTtRQUNELE9BQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBRWxCLGdCQUFXLEdBQUcsQ0FBcUIsU0FBNEIsRUFBRSxRQUFXO1lBQ3hFLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUMvRixLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUk7Z0JBQ2xDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDZixLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNqQyxDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDcEIsQ0FBQyxDQUFBO1FBQ0QsU0FBSSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7UUFFeEIsV0FBTSxHQUFHLENBQUMsWUFBK0IsRUFBRSxFQUFFLFFBQW1CO1lBQzVELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoRyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDO2dCQUNwQixFQUFFLENBQUMsQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUFDO29CQUN2QixLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDckMsSUFBSTtvQkFDQSxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3BDLENBQUMsQ0FBQTtRQUNELFFBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBRWxCLHNCQUFpQixHQUFHLENBQUMsWUFBK0IsRUFBRSxFQUFFLGNBQXVCLElBQUk7WUFDL0UsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2hHLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUM7b0JBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDekMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUMzQixDQUFDO1FBQ0wsQ0FBQyxDQUFBO1FBQ0QsbUJBQWMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUM7UUFFeEMsb0JBQWUsR0FBRyxDQUFDLFlBQStCLEVBQUUsRUFBRSxjQUF1QixJQUFJO1lBQzdFLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7WUFFN0IsR0FBRyxDQUFDLENBQUMsTUFBTSxXQUFXLElBQUksVUFBVSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbkUsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFFeEIsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQ3JELEVBQUUsQ0FBQyxDQUFDLFlBQVksS0FBSyxTQUFTLENBQUM7b0JBQzNCLEtBQUssR0FBRyxZQUFZLENBQUM7Z0JBQ3pCLElBQUk7b0JBQ0EsTUFBTSxDQUFDO1lBQ2YsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQztnQkFBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzdDLENBQUMsQ0FBQTtRQUNELGlCQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztRQUVwQyxZQUFPLEdBQUcsQ0FBQyxTQUE0QixFQUFFLElBQVUsRUFBRSxZQUFzQjtZQUN2RSxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEcsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQztnQkFDcEIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLFlBQVksR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMvRixDQUFDLENBQUE7UUFDRCxTQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUVwQix1QkFBa0IsR0FBRyxDQUFDLFNBQTRCLEVBQUUsSUFBVSxFQUFFLGNBQXVCLElBQUksRUFBRSxZQUFzQjtZQUMvRyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEcsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQztvQkFBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksWUFBWSxHQUFHLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUV4Ryx5QkFBeUIsS0FBaUI7b0JBQ3RDLEtBQUssQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxZQUFZLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ3ZGLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dCQUM1QyxDQUFDO2dCQUNELEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQzVDLENBQUM7UUFDTCxDQUFDLENBQUE7UUFDRCxvQkFBZSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztRQUUxQyxxQkFBZ0IsR0FBRyxDQUFDLFNBQTRCLEVBQUUsSUFBVSxFQUFFLGNBQXVCLElBQUksRUFBRSxZQUFzQjtZQUM3RyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1lBRTdCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sV0FBVyxJQUFJLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ25FLEtBQUssQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxZQUFZLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBRXZGLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUNyRCxFQUFFLENBQUMsQ0FBQyxZQUFZLEtBQUssU0FBUyxDQUFDO29CQUMzQixLQUFLLEdBQUcsWUFBWSxDQUFDO2dCQUN6QixJQUFJO29CQUNBLE1BQU0sQ0FBQztZQUNmLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUM7Z0JBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLFlBQVksR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM1RyxDQUFDLENBQUE7UUFDRCxrQkFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztRQUV0QyxRQUFHLEdBQUcsQ0FBQyxTQUE0QixFQUFFLFFBQW1CO1lBQ3BELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoRyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsRUFBRSxDQUFDLENBQUMsUUFBUSxLQUFLLFNBQVMsQ0FBQztvQkFDdkIsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN6QyxJQUFJO29CQUNBLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7WUFDeEMsQ0FBQztZQUFDLElBQUk7Z0JBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNyQixDQUFDLENBQUE7UUFFRCxtQkFBYyxHQUFHLENBQUMsU0FBNEIsRUFBRSxjQUF1QixJQUFJO1lBQ3ZFLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoRyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsRUFBRSxDQUFDLENBQUMsV0FBVyxJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztvQkFBQyxNQUFNLENBQUMsSUFBSSxDQUFDO2dCQUV6RCx1QkFBdUIsS0FBaUI7b0JBQ3BDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQzNCLE1BQU0sQ0FBQyxJQUFJLENBQUM7b0JBQ2hCLENBQUM7b0JBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ0osR0FBRyxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQzs0QkFDdkMsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO2dDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7d0JBRXpDLE1BQU0sQ0FBQyxLQUFLLENBQUM7b0JBQ2pCLENBQUM7Z0JBQ0wsQ0FBQztnQkFFRCxHQUFHLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO29CQUN2QyxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7d0JBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFFekMsTUFBTSxDQUFDLEtBQUssQ0FBQztZQUNqQixDQUFDO1lBQUMsSUFBSTtnQkFDRixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ3JCLENBQUMsQ0FBQTtRQUVELGlCQUFZLEdBQUcsQ0FBQyxTQUE0QixFQUFFLGNBQXVCLElBQUk7WUFDckUsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUU3QixHQUFHLENBQUMsQ0FBQyxNQUFNLFdBQVcsSUFBSSxVQUFVLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNuRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7b0JBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFFMUMsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQ3JELEVBQUUsQ0FBQyxDQUFDLFlBQVksS0FBSyxTQUFTLENBQUM7b0JBQzNCLEtBQUssR0FBRyxZQUFZLENBQUM7Z0JBQ3pCLElBQUk7b0JBQ0EsTUFBTSxDQUFDLEtBQUssQ0FBQztZQUNyQixDQUFDO1lBRUQsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDO2dCQUNaLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7WUFDcEMsSUFBSTtnQkFDQSxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ3JCLENBQUMsQ0FBQTtJQUNMLENBQUM7SUE3Skc7OztPQUdHO0lBQ0gsTUFBTSxDQUFDLG9CQUFvQixDQUFDLFNBQTRCO1FBQ3BELE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLFNBQVMsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7Q0F1Sko7QUE5SkQsZ0NBOEpDIiwiZmlsZSI6ImNsYXNzZXMvRXZlbnRTcGFjZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50U3BhY2VUeXBlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9FdmVudFNwYWNlVHlwZSc7XHJcbmltcG9ydCB7IExpc3RlbmVyIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9MaXN0ZW5lclR5cGUnO1xyXG5pbXBvcnQgeyBFdmVudExldmVsIH0gZnJvbSBcIi4vRXZlbnRMZXZlbFwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEV2ZW50U3BhY2UgaW1wbGVtZW50cyBFdmVudFNwYWNlVHlwZSB7XHJcbiAgICAvKipcclxuICAgICAqIOWwhuS6i+S7tuWQjei9rOaNouaIkOaVsOe7hOeahOW9ouW8j1xyXG4gICAgICogQHBhcmFtIGV2ZW50TmFtZSDkuovku7blkI3np7BcclxuICAgICAqL1xyXG4gICAgc3RhdGljIGNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZTogc3RyaW5nIHwgc3RyaW5nW10pIHtcclxuICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShldmVudE5hbWUpID8gZXZlbnROYW1lIDogZXZlbnROYW1lLnNwbGl0KCcuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBfZXZlbnRMZXZlbCA9IG5ldyBFdmVudExldmVsKCk7XHJcblxyXG4gICAgcmVjZWl2ZSA9IDxUIGV4dGVuZHMgTGlzdGVuZXI+KGV2ZW50TmFtZTogc3RyaW5nIHwgc3RyaW5nW10sIGxpc3RlbmVyOiBUKSA9PiB7XHJcbiAgICAgICAgdGhpcy5fZXZlbnRMZXZlbFxyXG4gICAgICAgICAgICAuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIHRydWUpXHJcbiAgICAgICAgICAgIC5yZWNlaXZlcnMuYWRkKGxpc3RlbmVyKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGxpc3RlbmVyO1xyXG4gICAgfVxyXG4gICAgb24gPSB0aGlzLnJlY2VpdmU7XHJcblxyXG4gICAgcmVjZWl2ZU9uY2UgPSA8VCBleHRlbmRzIExpc3RlbmVyPihldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBsaXN0ZW5lcjogVCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGxldmVsID0gdGhpcy5fZXZlbnRMZXZlbC5nZXRDaGlsZExldmVsKEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKSwgdHJ1ZSk7XHJcbiAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmFkZChmdW5jdGlvbiBvbmNlKGRhdGEpIHtcclxuICAgICAgICAgICAgbGlzdGVuZXIoZGF0YSk7XHJcbiAgICAgICAgICAgIGxldmVsLnJlY2VpdmVycy5kZWxldGUob25jZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBsaXN0ZW5lcjtcclxuICAgIH1cclxuICAgIG9uY2UgPSB0aGlzLnJlY2VpdmVPbmNlO1xyXG5cclxuICAgIGNhbmNlbCA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdID0gW10sIGxpc3RlbmVyPzogTGlzdGVuZXIpID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIGZhbHNlKTtcclxuICAgICAgICBpZiAobGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgaWYgKGxpc3RlbmVyICE9PSB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICBsZXZlbC5yZWNlaXZlcnMuZGVsZXRlKGxpc3RlbmVyKTtcclxuICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgICBvZmYgPSB0aGlzLmNhbmNlbDtcclxuXHJcbiAgICBjYW5jZWxEZXNjZW5kYW50cyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdID0gW10sIGluY2x1ZGVTZWxmOiBib29sZWFuID0gdHJ1ZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGxldmVsID0gdGhpcy5fZXZlbnRMZXZlbC5nZXRDaGlsZExldmVsKEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKSwgZmFsc2UpO1xyXG4gICAgICAgIGlmIChsZXZlbCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGlmIChpbmNsdWRlU2VsZikgbGV2ZWwucmVjZWl2ZXJzLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIGxldmVsLmNoaWxkcmVuLmNsZWFyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgb2ZmRGVzY2VuZGFudHMgPSB0aGlzLmNhbmNlbERlc2NlbmRhbnRzO1xyXG5cclxuICAgIGNhbmNlbEFuY2VzdG9ycyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdID0gW10sIGluY2x1ZGVTZWxmOiBib29sZWFuID0gdHJ1ZSkgPT4ge1xyXG4gICAgICAgIGxldCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWw7XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgY3VycmVudE5hbWUgb2YgRXZlbnRTcGFjZS5jb252ZXJ0RXZlbnROYW1lVHlwZShldmVudE5hbWUpKSB7XHJcbiAgICAgICAgICAgIGxldmVsLnJlY2VpdmVycy5jbGVhcigpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY3VycmVudExldmVsID0gbGV2ZWwuY2hpbGRyZW4uZ2V0KGN1cnJlbnROYW1lKTtcclxuICAgICAgICAgICAgaWYgKGN1cnJlbnRMZXZlbCAhPT0gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAgICAgbGV2ZWwgPSBjdXJyZW50TGV2ZWw7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChpbmNsdWRlU2VsZikgbGV2ZWwucmVjZWl2ZXJzLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgICBvZmZBbmNlc3RvcnMgPSB0aGlzLmNhbmNlbEFuY2VzdG9ycztcclxuXHJcbiAgICB0cmlnZ2VyID0gKGV2ZW50TmFtZTogc3RyaW5nIHwgc3RyaW5nW10sIGRhdGE/OiBhbnksIGFzeW5jaHJvbm91cz86IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIGZhbHNlKTtcclxuICAgICAgICBpZiAobGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmZvckVhY2goaXRlbSA9PiBhc3luY2hyb25vdXMgPyBzZXRUaW1lb3V0KGl0ZW0sIDAsIGRhdGEpIDogaXRlbShkYXRhKSk7XHJcbiAgICB9XHJcbiAgICBzZW5kID0gdGhpcy50cmlnZ2VyO1xyXG5cclxuICAgIHRyaWdnZXJEZXNjZW5kYW50cyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBkYXRhPzogYW55LCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUsIGFzeW5jaHJvbm91cz86IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIGZhbHNlKTtcclxuICAgICAgICBpZiAobGV2ZWwgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpZiAoaW5jbHVkZVNlbGYpIGxldmVsLnJlY2VpdmVycy5mb3JFYWNoKGl0ZW0gPT4gYXN5bmNocm9ub3VzID8gc2V0VGltZW91dChpdGVtLCAwLCBkYXRhKSA6IGl0ZW0oZGF0YSkpO1xyXG5cclxuICAgICAgICAgICAgZnVuY3Rpb24gdHJpZ2dlckNoaWxkcmVuKGxldmVsOiBFdmVudExldmVsKSB7XHJcbiAgICAgICAgICAgICAgICBsZXZlbC5yZWNlaXZlcnMuZm9yRWFjaChpdGVtID0+IGFzeW5jaHJvbm91cyA/IHNldFRpbWVvdXQoaXRlbSwgMCwgZGF0YSkgOiBpdGVtKGRhdGEpKTtcclxuICAgICAgICAgICAgICAgIGxldmVsLmNoaWxkcmVuLmZvckVhY2godHJpZ2dlckNoaWxkcmVuKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXZlbC5jaGlsZHJlbi5mb3JFYWNoKHRyaWdnZXJDaGlsZHJlbik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc2VuZERlc2NlbmRhbnRzID0gdGhpcy50cmlnZ2VyRGVzY2VuZGFudHM7XHJcblxyXG4gICAgdHJpZ2dlckFuY2VzdG9ycyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBkYXRhPzogYW55LCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUsIGFzeW5jaHJvbm91cz86IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBsZXQgbGV2ZWwgPSB0aGlzLl9ldmVudExldmVsO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGN1cnJlbnROYW1lIG9mIEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKSkge1xyXG4gICAgICAgICAgICBsZXZlbC5yZWNlaXZlcnMuZm9yRWFjaChpdGVtID0+IGFzeW5jaHJvbm91cyA/IHNldFRpbWVvdXQoaXRlbSwgMCwgZGF0YSkgOiBpdGVtKGRhdGEpKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRMZXZlbCA9IGxldmVsLmNoaWxkcmVuLmdldChjdXJyZW50TmFtZSk7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50TGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgIGxldmVsID0gY3VycmVudExldmVsO1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoaW5jbHVkZVNlbGYpIGxldmVsLnJlY2VpdmVycy5mb3JFYWNoKGl0ZW0gPT4gYXN5bmNocm9ub3VzID8gc2V0VGltZW91dChpdGVtLCAwLCBkYXRhKSA6IGl0ZW0oZGF0YSkpO1xyXG4gICAgfVxyXG4gICAgc2VuZEFuY2VzdG9ycyA9IHRoaXMudHJpZ2dlckFuY2VzdG9ycztcclxuXHJcbiAgICBoYXMgPSAoZXZlbnROYW1lOiBzdHJpbmcgfCBzdHJpbmdbXSwgbGlzdGVuZXI/OiBMaXN0ZW5lcikgPT4ge1xyXG4gICAgICAgIGNvbnN0IGxldmVsID0gdGhpcy5fZXZlbnRMZXZlbC5nZXRDaGlsZExldmVsKEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKSwgZmFsc2UpO1xyXG4gICAgICAgIGlmIChsZXZlbCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGlmIChsaXN0ZW5lciAhPT0gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGxldmVsLnJlY2VpdmVycy5oYXMobGlzdGVuZXIpO1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbGV2ZWwucmVjZWl2ZXJzLnNpemUgPiAwO1xyXG4gICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgaGFzRGVzY2VuZGFudHMgPSAoZXZlbnROYW1lOiBzdHJpbmcgfCBzdHJpbmdbXSwgaW5jbHVkZVNlbGY6IGJvb2xlYW4gPSB0cnVlKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbGV2ZWwgPSB0aGlzLl9ldmVudExldmVsLmdldENoaWxkTGV2ZWwoRXZlbnRTcGFjZS5jb252ZXJ0RXZlbnROYW1lVHlwZShldmVudE5hbWUpLCBmYWxzZSk7XHJcbiAgICAgICAgaWYgKGxldmVsICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgaWYgKGluY2x1ZGVTZWxmICYmIGxldmVsLnJlY2VpdmVycy5zaXplID4gMCkgcmV0dXJuIHRydWU7XHJcblxyXG4gICAgICAgICAgICBmdW5jdGlvbiBjaGVja0NoaWxkcmVuKGxldmVsOiBFdmVudExldmVsKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAobGV2ZWwucmVjZWl2ZXJzLnNpemUgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBsZXZlbC5jaGlsZHJlbi52YWx1ZXMoKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoZWNrQ2hpbGRyZW4oaXRlbSkpIHJldHVybiB0cnVlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBsZXZlbC5jaGlsZHJlbi52YWx1ZXMoKSlcclxuICAgICAgICAgICAgICAgIGlmIChjaGVja0NoaWxkcmVuKGl0ZW0pKSByZXR1cm4gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGhhc0FuY2VzdG9ycyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUpID0+IHtcclxuICAgICAgICBsZXQgbGV2ZWwgPSB0aGlzLl9ldmVudExldmVsO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGN1cnJlbnROYW1lIG9mIEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKSkge1xyXG4gICAgICAgICAgICBpZiAobGV2ZWwucmVjZWl2ZXJzLnNpemUgPiAwKSByZXR1cm4gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRMZXZlbCA9IGxldmVsLmNoaWxkcmVuLmdldChjdXJyZW50TmFtZSk7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50TGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgIGxldmVsID0gY3VycmVudExldmVsO1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoaW5jbHVkZVNlbGYpXHJcbiAgICAgICAgICAgIHJldHVybiBsZXZlbC5yZWNlaXZlcnMuc2l6ZSA+IDA7XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbn0iXX0=
