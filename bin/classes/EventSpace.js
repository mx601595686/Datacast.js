"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const EventLevel_1 = require("./EventLevel");
class EventSpace {
    constructor() {
        this._eventLevel = new EventLevel_1.EventLevel();
        this.receive = (eventName, listener) => {
            this._eventLevel
                .getChildLevel(EventSpace.convertEventNameType(eventName), true)
                .receivers.add(listener);
            return listener;
        };
        this.on = this.receive;
        this.receiveOnce = (eventName, listener) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), true);
            level.receivers.add(function once(data) {
                listener(data);
                level.receivers.delete(once);
            });
            return listener;
        };
        this.once = this.receiveOnce;
        this.cancel = (eventName = [], listener) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined)
                if (listener !== undefined)
                    level.receivers.delete(listener);
                else
                    level.receivers.clear();
        };
        this.off = this.cancel;
        this.cancelDescendants = (eventName = [], includeSelf = true) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (includeSelf)
                    level.receivers.clear();
                level.children.clear();
            }
        };
        this.offDescendants = this.cancelDescendants;
        this.cancelAncestors = (eventName = [], includeSelf = true) => {
            eventName = EventSpace.convertEventNameType(eventName);
            let level = this._eventLevel;
            for (var index = 0; index < eventName.length; index++) {
                level.receivers.clear();
                const currentLevel = level.children.get(eventName[index]);
                if (currentLevel !== undefined)
                    level = currentLevel;
                else
                    break;
            }
            if (includeSelf && index === eventName.length)
                level.receivers.clear();
        };
        this.offAncestors = this.cancelAncestors;
        this.trigger = (eventName, data, asynchronous) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined)
                level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
        };
        this.send = this.trigger;
        this.triggerDescendants = (eventName, data, includeSelf = true, asynchronous) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (includeSelf)
                    level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
                function triggerChildren(level) {
                    level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
                    level.children.forEach(triggerChildren);
                }
                level.children.forEach(triggerChildren);
            }
        };
        this.sendDescendants = this.triggerDescendants;
        this.triggerAncestors = (eventName, data, includeSelf = true, asynchronous) => {
            eventName = EventSpace.convertEventNameType(eventName);
            let level = this._eventLevel;
            for (var index = 0; index < eventName.length; index++) {
                level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
                const currentLevel = level.children.get(eventName[index]);
                if (currentLevel !== undefined)
                    level = currentLevel;
                else
                    break;
            }
            if (includeSelf && index === eventName.length)
                level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
        };
        this.sendAncestors = this.triggerAncestors;
        this.has = (eventName, listener) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (listener !== undefined)
                    return level.receivers.has(listener);
                else
                    return level.receivers.size > 0;
            }
            else
                return false;
        };
        this.hasDescendants = (eventName, includeSelf = true) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (includeSelf && level.receivers.size > 0)
                    return true;
                function checkChildren(level) {
                    if (level.receivers.size > 0) {
                        return true;
                    }
                    else {
                        for (const item of level.children.values())
                            if (checkChildren(item))
                                return true;
                        return false;
                    }
                }
                for (const item of level.children.values())
                    if (checkChildren(item))
                        return true;
                return false;
            }
            else
                return false;
        };
        this.hasAncestors = (eventName, includeSelf = true) => {
            eventName = EventSpace.convertEventNameType(eventName);
            let level = this._eventLevel;
            for (var index = 0; index < eventName.length; index++) {
                if (level.receivers.size > 0)
                    return true;
                const currentLevel = level.children.get(eventName[index]);
                if (currentLevel !== undefined)
                    level = currentLevel;
                else
                    return false;
            }
            if (includeSelf)
                return level.receivers.size > 0;
            else
                return false;
        };
    }
    /**
     * 将事件名转换成数组的形式
     * @param eventName 事件名称
     */
    static convertEventNameType(eventName) {
        return Array.isArray(eventName) ? eventName : eventName.split('.');
    }
}
exports.EventSpace = EventSpace;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsYXNzZXMvRXZlbnRTcGFjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLDZDQUEwQztBQUUxQztJQUFBO1FBU3FCLGdCQUFXLEdBQUcsSUFBSSx1QkFBVSxFQUFFLENBQUM7UUFFaEQsWUFBTyxHQUFHLENBQXFCLFNBQTRCLEVBQUUsUUFBVztZQUNwRSxJQUFJLENBQUMsV0FBVztpQkFDWCxhQUFhLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksQ0FBQztpQkFDL0QsU0FBUyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUU3QixNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ3BCLENBQUMsQ0FBQTtRQUNELE9BQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBRWxCLGdCQUFXLEdBQUcsQ0FBcUIsU0FBNEIsRUFBRSxRQUFXO1lBQ3hFLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUMvRixLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUk7Z0JBQ2xDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDZixLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNqQyxDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDcEIsQ0FBQyxDQUFBO1FBQ0QsU0FBSSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7UUFFeEIsV0FBTSxHQUFHLENBQUMsWUFBK0IsRUFBRSxFQUFFLFFBQW1CO1lBQzVELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoRyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDO2dCQUNwQixFQUFFLENBQUMsQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUFDO29CQUN2QixLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDckMsSUFBSTtvQkFDQSxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3BDLENBQUMsQ0FBQTtRQUNELFFBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBRWxCLHNCQUFpQixHQUFHLENBQUMsWUFBK0IsRUFBRSxFQUFFLGNBQXVCLElBQUk7WUFDL0UsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2hHLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUM7b0JBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDekMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUMzQixDQUFDO1FBQ0wsQ0FBQyxDQUFBO1FBQ0QsbUJBQWMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUM7UUFFeEMsb0JBQWUsR0FBRyxDQUFDLFlBQStCLEVBQUUsRUFBRSxjQUF1QixJQUFJO1lBQzdFLFNBQVMsR0FBRyxVQUFVLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdkQsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUU3QixHQUFHLENBQUMsQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQztnQkFDcEQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFFeEIsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQzFELEVBQUUsQ0FBQyxDQUFDLFlBQVksS0FBSyxTQUFTLENBQUM7b0JBQzNCLEtBQUssR0FBRyxZQUFZLENBQUM7Z0JBQ3pCLElBQUk7b0JBQ0EsS0FBSyxDQUFDO1lBQ2QsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLFdBQVcsSUFBSSxLQUFLLEtBQUssU0FBUyxDQUFDLE1BQU0sQ0FBQztnQkFBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzNFLENBQUMsQ0FBQTtRQUNELGlCQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztRQUVwQyxZQUFPLEdBQUcsQ0FBQyxTQUE0QixFQUFFLElBQVUsRUFBRSxZQUFzQjtZQUN2RSxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEcsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQztnQkFDcEIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLFlBQVksR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMvRixDQUFDLENBQUE7UUFDRCxTQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUVwQix1QkFBa0IsR0FBRyxDQUFDLFNBQTRCLEVBQUUsSUFBVSxFQUFFLGNBQXVCLElBQUksRUFBRSxZQUFzQjtZQUMvRyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEcsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQztvQkFBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksWUFBWSxHQUFHLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUV4Ryx5QkFBeUIsS0FBaUI7b0JBQ3RDLEtBQUssQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxZQUFZLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ3ZGLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dCQUM1QyxDQUFDO2dCQUNELEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQzVDLENBQUM7UUFDTCxDQUFDLENBQUE7UUFDRCxvQkFBZSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztRQUUxQyxxQkFBZ0IsR0FBRyxDQUFDLFNBQTRCLEVBQUUsSUFBVSxFQUFFLGNBQXVCLElBQUksRUFBRSxZQUFzQjtZQUM3RyxTQUFTLEdBQUcsVUFBVSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZELElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7WUFFN0IsR0FBRyxDQUFDLENBQUMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFLEtBQUssR0FBRyxTQUFTLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUM7Z0JBQ3BELEtBQUssQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxZQUFZLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBRXZGLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUMxRCxFQUFFLENBQUMsQ0FBQyxZQUFZLEtBQUssU0FBUyxDQUFDO29CQUMzQixLQUFLLEdBQUcsWUFBWSxDQUFDO2dCQUN6QixJQUFJO29CQUNBLEtBQUssQ0FBQztZQUNkLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxXQUFXLElBQUksS0FBSyxLQUFLLFNBQVMsQ0FBQyxNQUFNLENBQUM7Z0JBQzFDLEtBQUssQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxZQUFZLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDL0YsQ0FBQyxDQUFBO1FBQ0Qsa0JBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFFdEMsUUFBRyxHQUFHLENBQUMsU0FBNEIsRUFBRSxRQUFtQjtZQUNwRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEcsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLEVBQUUsQ0FBQyxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUM7b0JBQ3ZCLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDekMsSUFBSTtvQkFDQSxNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQ3hDLENBQUM7WUFBQyxJQUFJO2dCQUNGLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDckIsQ0FBQyxDQUFBO1FBRUQsbUJBQWMsR0FBRyxDQUFDLFNBQTRCLEVBQUUsY0FBdUIsSUFBSTtZQUN2RSxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEcsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLEVBQUUsQ0FBQyxDQUFDLFdBQVcsSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7b0JBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFFekQsdUJBQXVCLEtBQWlCO29CQUNwQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUMzQixNQUFNLENBQUMsSUFBSSxDQUFDO29CQUNoQixDQUFDO29CQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNKLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7NEJBQ3ZDLEVBQUUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO3dCQUV6QyxNQUFNLENBQUMsS0FBSyxDQUFDO29CQUNqQixDQUFDO2dCQUNMLENBQUM7Z0JBRUQsR0FBRyxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztvQkFDdkMsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO3dCQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7Z0JBRXpDLE1BQU0sQ0FBQyxLQUFLLENBQUM7WUFDakIsQ0FBQztZQUFDLElBQUk7Z0JBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNyQixDQUFDLENBQUE7UUFFRCxpQkFBWSxHQUFHLENBQUMsU0FBNEIsRUFBRSxjQUF1QixJQUFJO1lBQ3JFLFNBQVMsR0FBRyxVQUFVLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdkQsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUU3QixHQUFHLENBQUMsQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQztnQkFDcEQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO29CQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7Z0JBRTFDLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUMxRCxFQUFFLENBQUMsQ0FBQyxZQUFZLEtBQUssU0FBUyxDQUFDO29CQUMzQixLQUFLLEdBQUcsWUFBWSxDQUFDO2dCQUN6QixJQUFJO29CQUNBLE1BQU0sQ0FBQyxLQUFLLENBQUM7WUFDckIsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQztnQkFDWixNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQ3BDLElBQUk7Z0JBQ0EsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNyQixDQUFDLENBQUE7SUFDTCxDQUFDO0lBaktHOzs7T0FHRztJQUNILE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxTQUE0QjtRQUNwRCxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxTQUFTLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2RSxDQUFDO0NBMkpKO0FBbEtELGdDQWtLQyIsImZpbGUiOiJjbGFzc2VzL0V2ZW50U3BhY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudFNwYWNlVHlwZSB9IGZyb20gJy4uL2ludGVyZmFjZXMvRXZlbnRTcGFjZVR5cGUnO1xyXG5pbXBvcnQgeyBMaXN0ZW5lciB9IGZyb20gJy4uL2ludGVyZmFjZXMvTGlzdGVuZXJUeXBlJztcclxuaW1wb3J0IHsgRXZlbnRMZXZlbCB9IGZyb20gXCIuL0V2ZW50TGV2ZWxcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBFdmVudFNwYWNlIGltcGxlbWVudHMgRXZlbnRTcGFjZVR5cGUge1xyXG4gICAgLyoqXHJcbiAgICAgKiDlsIbkuovku7blkI3ovazmjaLmiJDmlbDnu4TnmoTlvaLlvI9cclxuICAgICAqIEBwYXJhbSBldmVudE5hbWUg5LqL5Lu25ZCN56ewXHJcbiAgICAgKi9cclxuICAgIHN0YXRpYyBjb252ZXJ0RXZlbnROYW1lVHlwZShldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdKSB7XHJcbiAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoZXZlbnROYW1lKSA/IGV2ZW50TmFtZSA6IGV2ZW50TmFtZS5zcGxpdCgnLicpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2V2ZW50TGV2ZWwgPSBuZXcgRXZlbnRMZXZlbCgpO1xyXG5cclxuICAgIHJlY2VpdmUgPSA8VCBleHRlbmRzIExpc3RlbmVyPihldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBsaXN0ZW5lcjogVCkgPT4ge1xyXG4gICAgICAgIHRoaXMuX2V2ZW50TGV2ZWxcclxuICAgICAgICAgICAgLmdldENoaWxkTGV2ZWwoRXZlbnRTcGFjZS5jb252ZXJ0RXZlbnROYW1lVHlwZShldmVudE5hbWUpLCB0cnVlKVxyXG4gICAgICAgICAgICAucmVjZWl2ZXJzLmFkZChsaXN0ZW5lcik7XHJcblxyXG4gICAgICAgIHJldHVybiBsaXN0ZW5lcjtcclxuICAgIH1cclxuICAgIG9uID0gdGhpcy5yZWNlaXZlO1xyXG5cclxuICAgIHJlY2VpdmVPbmNlID0gPFQgZXh0ZW5kcyBMaXN0ZW5lcj4oZXZlbnROYW1lOiBzdHJpbmcgfCBzdHJpbmdbXSwgbGlzdGVuZXI6IFQpID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIHRydWUpO1xyXG4gICAgICAgIGxldmVsLnJlY2VpdmVycy5hZGQoZnVuY3Rpb24gb25jZShkYXRhKSB7XHJcbiAgICAgICAgICAgIGxpc3RlbmVyKGRhdGEpO1xyXG4gICAgICAgICAgICBsZXZlbC5yZWNlaXZlcnMuZGVsZXRlKG9uY2UpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gbGlzdGVuZXI7XHJcbiAgICB9XHJcbiAgICBvbmNlID0gdGhpcy5yZWNlaXZlT25jZTtcclxuXHJcbiAgICBjYW5jZWwgPSAoZXZlbnROYW1lOiBzdHJpbmcgfCBzdHJpbmdbXSA9IFtdLCBsaXN0ZW5lcj86IExpc3RlbmVyKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbGV2ZWwgPSB0aGlzLl9ldmVudExldmVsLmdldENoaWxkTGV2ZWwoRXZlbnRTcGFjZS5jb252ZXJ0RXZlbnROYW1lVHlwZShldmVudE5hbWUpLCBmYWxzZSk7XHJcbiAgICAgICAgaWYgKGxldmVsICE9PSB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgIGlmIChsaXN0ZW5lciAhPT0gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmRlbGV0ZShsaXN0ZW5lcik7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIGxldmVsLnJlY2VpdmVycy5jbGVhcigpO1xyXG4gICAgfVxyXG4gICAgb2ZmID0gdGhpcy5jYW5jZWw7XHJcblxyXG4gICAgY2FuY2VsRGVzY2VuZGFudHMgPSAoZXZlbnROYW1lOiBzdHJpbmcgfCBzdHJpbmdbXSA9IFtdLCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUpID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIGZhbHNlKTtcclxuICAgICAgICBpZiAobGV2ZWwgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpZiAoaW5jbHVkZVNlbGYpIGxldmVsLnJlY2VpdmVycy5jbGVhcigpO1xyXG4gICAgICAgICAgICBsZXZlbC5jaGlsZHJlbi5jbGVhcigpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIG9mZkRlc2NlbmRhbnRzID0gdGhpcy5jYW5jZWxEZXNjZW5kYW50cztcclxuXHJcbiAgICBjYW5jZWxBbmNlc3RvcnMgPSAoZXZlbnROYW1lOiBzdHJpbmcgfCBzdHJpbmdbXSA9IFtdLCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUpID0+IHtcclxuICAgICAgICBldmVudE5hbWUgPSBFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSk7XHJcbiAgICAgICAgbGV0IGxldmVsID0gdGhpcy5fZXZlbnRMZXZlbDtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGV2ZW50TmFtZS5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmNsZWFyKCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50TGV2ZWwgPSBsZXZlbC5jaGlsZHJlbi5nZXQoZXZlbnROYW1lW2luZGV4XSk7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50TGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgIGxldmVsID0gY3VycmVudExldmVsO1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChpbmNsdWRlU2VsZiAmJiBpbmRleCA9PT0gZXZlbnROYW1lLmxlbmd0aCkgbGV2ZWwucmVjZWl2ZXJzLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgICBvZmZBbmNlc3RvcnMgPSB0aGlzLmNhbmNlbEFuY2VzdG9ycztcclxuXHJcbiAgICB0cmlnZ2VyID0gKGV2ZW50TmFtZTogc3RyaW5nIHwgc3RyaW5nW10sIGRhdGE/OiBhbnksIGFzeW5jaHJvbm91cz86IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIGZhbHNlKTtcclxuICAgICAgICBpZiAobGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmZvckVhY2goaXRlbSA9PiBhc3luY2hyb25vdXMgPyBzZXRUaW1lb3V0KGl0ZW0sIDAsIGRhdGEpIDogaXRlbShkYXRhKSk7XHJcbiAgICB9XHJcbiAgICBzZW5kID0gdGhpcy50cmlnZ2VyO1xyXG5cclxuICAgIHRyaWdnZXJEZXNjZW5kYW50cyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBkYXRhPzogYW55LCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUsIGFzeW5jaHJvbm91cz86IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIGZhbHNlKTtcclxuICAgICAgICBpZiAobGV2ZWwgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpZiAoaW5jbHVkZVNlbGYpIGxldmVsLnJlY2VpdmVycy5mb3JFYWNoKGl0ZW0gPT4gYXN5bmNocm9ub3VzID8gc2V0VGltZW91dChpdGVtLCAwLCBkYXRhKSA6IGl0ZW0oZGF0YSkpO1xyXG5cclxuICAgICAgICAgICAgZnVuY3Rpb24gdHJpZ2dlckNoaWxkcmVuKGxldmVsOiBFdmVudExldmVsKSB7XHJcbiAgICAgICAgICAgICAgICBsZXZlbC5yZWNlaXZlcnMuZm9yRWFjaChpdGVtID0+IGFzeW5jaHJvbm91cyA/IHNldFRpbWVvdXQoaXRlbSwgMCwgZGF0YSkgOiBpdGVtKGRhdGEpKTtcclxuICAgICAgICAgICAgICAgIGxldmVsLmNoaWxkcmVuLmZvckVhY2godHJpZ2dlckNoaWxkcmVuKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXZlbC5jaGlsZHJlbi5mb3JFYWNoKHRyaWdnZXJDaGlsZHJlbik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc2VuZERlc2NlbmRhbnRzID0gdGhpcy50cmlnZ2VyRGVzY2VuZGFudHM7XHJcblxyXG4gICAgdHJpZ2dlckFuY2VzdG9ycyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBkYXRhPzogYW55LCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUsIGFzeW5jaHJvbm91cz86IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBldmVudE5hbWUgPSBFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSk7XHJcbiAgICAgICAgbGV0IGxldmVsID0gdGhpcy5fZXZlbnRMZXZlbDtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGV2ZW50TmFtZS5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmZvckVhY2goaXRlbSA9PiBhc3luY2hyb25vdXMgPyBzZXRUaW1lb3V0KGl0ZW0sIDAsIGRhdGEpIDogaXRlbShkYXRhKSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50TGV2ZWwgPSBsZXZlbC5jaGlsZHJlbi5nZXQoZXZlbnROYW1lW2luZGV4XSk7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50TGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgIGxldmVsID0gY3VycmVudExldmVsO1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChpbmNsdWRlU2VsZiAmJiBpbmRleCA9PT0gZXZlbnROYW1lLmxlbmd0aClcclxuICAgICAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmZvckVhY2goaXRlbSA9PiBhc3luY2hyb25vdXMgPyBzZXRUaW1lb3V0KGl0ZW0sIDAsIGRhdGEpIDogaXRlbShkYXRhKSk7XHJcbiAgICB9XHJcbiAgICBzZW5kQW5jZXN0b3JzID0gdGhpcy50cmlnZ2VyQW5jZXN0b3JzO1xyXG5cclxuICAgIGhhcyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBsaXN0ZW5lcj86IExpc3RlbmVyKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbGV2ZWwgPSB0aGlzLl9ldmVudExldmVsLmdldENoaWxkTGV2ZWwoRXZlbnRTcGFjZS5jb252ZXJ0RXZlbnROYW1lVHlwZShldmVudE5hbWUpLCBmYWxzZSk7XHJcbiAgICAgICAgaWYgKGxldmVsICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgaWYgKGxpc3RlbmVyICE9PSB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbGV2ZWwucmVjZWl2ZXJzLmhhcyhsaXN0ZW5lcik7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHJldHVybiBsZXZlbC5yZWNlaXZlcnMuc2l6ZSA+IDA7XHJcbiAgICAgICAgfSBlbHNlXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBoYXNEZXNjZW5kYW50cyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUpID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIGZhbHNlKTtcclxuICAgICAgICBpZiAobGV2ZWwgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpZiAoaW5jbHVkZVNlbGYgJiYgbGV2ZWwucmVjZWl2ZXJzLnNpemUgPiAwKSByZXR1cm4gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrQ2hpbGRyZW4obGV2ZWw6IEV2ZW50TGV2ZWwpIHtcclxuICAgICAgICAgICAgICAgIGlmIChsZXZlbC5yZWNlaXZlcnMuc2l6ZSA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGxldmVsLmNoaWxkcmVuLnZhbHVlcygpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hlY2tDaGlsZHJlbihpdGVtKSkgcmV0dXJuIHRydWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGxldmVsLmNoaWxkcmVuLnZhbHVlcygpKVxyXG4gICAgICAgICAgICAgICAgaWYgKGNoZWNrQ2hpbGRyZW4oaXRlbSkpIHJldHVybiB0cnVlO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgaGFzQW5jZXN0b3JzID0gKGV2ZW50TmFtZTogc3RyaW5nIHwgc3RyaW5nW10sIGluY2x1ZGVTZWxmOiBib29sZWFuID0gdHJ1ZSkgPT4ge1xyXG4gICAgICAgIGV2ZW50TmFtZSA9IEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKTtcclxuICAgICAgICBsZXQgbGV2ZWwgPSB0aGlzLl9ldmVudExldmVsO1xyXG5cclxuICAgICAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgZXZlbnROYW1lLmxlbmd0aDsgaW5kZXgrKykge1xyXG4gICAgICAgICAgICBpZiAobGV2ZWwucmVjZWl2ZXJzLnNpemUgPiAwKSByZXR1cm4gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRMZXZlbCA9IGxldmVsLmNoaWxkcmVuLmdldChldmVudE5hbWVbaW5kZXhdKTtcclxuICAgICAgICAgICAgaWYgKGN1cnJlbnRMZXZlbCAhPT0gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAgICAgbGV2ZWwgPSBjdXJyZW50TGV2ZWw7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChpbmNsdWRlU2VsZilcclxuICAgICAgICAgICAgcmV0dXJuIGxldmVsLnJlY2VpdmVycy5zaXplID4gMDtcclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxufSJdfQ==
