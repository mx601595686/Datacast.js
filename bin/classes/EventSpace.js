"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const EventLevel_1 = require("./EventLevel");
class EventSpace {
    constructor() {
        this._eventLevel = new EventLevel_1.EventLevel();
        this.receive = (eventName, listener) => {
            this._eventLevel
                .getChildLevel(EventSpace.convertEventNameType(eventName), true)
                .receivers.add(listener);
            return listener;
        };
        this.on = this.receive;
        this.receiveOnce = (eventName, listener) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), true);
            level.receivers.add(function once(data) {
                listener(data);
                level.receivers.delete(once);
            });
            return listener;
        };
        this.once = this.receiveOnce;
        this.cancel = (eventName = [], listener) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined)
                if (listener !== undefined)
                    level.receivers.delete(listener);
                else
                    level.receivers.clear();
        };
        this.off = this.cancel;
        this.cancelDescendants = (eventName = [], includeSelf = true) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (includeSelf)
                    level.receivers.clear();
                level.children.clear();
            }
        };
        this.offDescendants = this.cancelDescendants;
        this.cancelAncestors = (eventName = [], includeSelf = true) => {
            let level = this._eventLevel;
            for (const currentName of EventSpace.convertEventNameType(eventName)) {
                level.receivers.clear();
                const currentLevel = level.children.get(currentName);
                if (currentLevel !== undefined)
                    level = currentLevel;
                else
                    return;
            }
            if (includeSelf)
                level.receivers.clear();
        };
        this.offAncestors = this.cancelAncestors;
        this.trigger = (eventName, data, asynchronous) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined)
                level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
        };
        this.send = this.trigger;
        this.triggerDescendants = (eventName, data, includeSelf = true, asynchronous) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (includeSelf)
                    level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
                function triggerChildren(level) {
                    level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
                    level.children.forEach(triggerChildren);
                }
                level.children.forEach(triggerChildren);
            }
        };
        this.sendDescendants = this.triggerDescendants;
        this.triggerAncestors = (eventName, data, includeSelf = true, asynchronous) => {
            let level = this._eventLevel;
            for (const currentName of EventSpace.convertEventNameType(eventName)) {
                level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
                const currentLevel = level.children.get(currentName);
                if (currentLevel !== undefined)
                    level = currentLevel;
                else
                    return;
            }
            if (includeSelf)
                level.receivers.forEach(item => asynchronous ? setTimeout(item, 0, data) : item(data));
        };
        this.sendAncestors = this.triggerAncestors;
        this.has = (eventName, listener) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (listener !== undefined)
                    return level.receivers.has(listener);
                else
                    return level.receivers.size > 0;
            }
            else
                return false;
        };
        this.hasDescendants = (eventName, includeSelf = true) => {
            const level = this._eventLevel.getChildLevel(EventSpace.convertEventNameType(eventName), false);
            if (level !== undefined) {
                if (includeSelf && level.receivers.size > 0)
                    return true;
                function checkChildren(level) {
                    if (level.receivers.size > 0) {
                        return true;
                    }
                    else {
                        for (const item of level.children.values())
                            if (checkChildren(item))
                                return true;
                        return false;
                    }
                }
                for (const item of level.children.values())
                    if (checkChildren(item))
                        return true;
                return false;
            }
            else
                return false;
        };
        this.hasAncestors = (eventName, includeSelf = true) => {
            let level = this._eventLevel;
            for (const currentName of EventSpace.convertEventNameType(eventName)) {
                if (level.receivers.size > 0)
                    return true;
                const currentLevel = level.children.get(currentName);
                if (currentLevel !== undefined)
                    level = currentLevel;
                else
                    return false;
            }
            if (includeSelf)
                return level.receivers.size > 0;
            else
                return false;
        };
    }
    /**
     * 将事件名转换成数组的形式
     * @param eventName 事件名称
     */
    static convertEventNameType(eventName) {
        return Array.isArray(eventName) ? eventName : eventName.split('.');
    }
}
exports.EventSpace = EventSpace;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDckQsRUFBRSxDQUFDLENBQUMsWUFBWSxLQUFLLFNBQVMsQ0FBQztvQkFDM0IsS0FBSyxHQUFHLFlBQVksQ0FBQztnQkFDekIsSUFBSTtvQkFDQSxNQUFNLENBQUMsS0FBSyxDQUFDO1lBQ3JCLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUM7Z0JBQ1osTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztZQUNwQyxJQUFJO2dCQUNBLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDckIsQ0FBQyxDQUFBO0lBQ0wsQ0FBQztJQTdKRzs7O09BR0c7SUFDSCxNQUFNLENBQUMsb0JBQW9CLENBQUMsU0FBNEI7UUFDcEQsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsU0FBUyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdkUsQ0FBQztDQXVKSjtBQTlKRCxnQ0E4SkMiLCJmaWxlIjoiY2xhc3Nlcy9FdmVudFNwYWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRTcGFjZVR5cGUgfSBmcm9tICcuLi9pbnRlcmZhY2VzL0V2ZW50U3BhY2VUeXBlJztcclxuaW1wb3J0IHsgTGlzdGVuZXIgfSBmcm9tICcuLi9pbnRlcmZhY2VzL0xpc3RlbmVyVHlwZSc7XHJcbmltcG9ydCB7IEV2ZW50TGV2ZWwgfSBmcm9tIFwiLi9FdmVudExldmVsXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRXZlbnRTcGFjZSBpbXBsZW1lbnRzIEV2ZW50U3BhY2VUeXBlIHtcclxuICAgIC8qKlxyXG4gICAgICog5bCG5LqL5Lu25ZCN6L2s5o2i5oiQ5pWw57uE55qE5b2i5byPXHJcbiAgICAgKiBAcGFyYW0gZXZlbnROYW1lIOS6i+S7tuWQjeensFxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lOiBzdHJpbmcgfCBzdHJpbmdbXSkge1xyXG4gICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KGV2ZW50TmFtZSkgPyBldmVudE5hbWUgOiBldmVudE5hbWUuc3BsaXQoJy4nKTtcclxuICAgIH1cclxuXHJcbiAgICByZWFkb25seSBfZXZlbnRMZXZlbCA9IG5ldyBFdmVudExldmVsKCk7XHJcblxyXG4gICAgcmVjZWl2ZSA9IDxUIGV4dGVuZHMgTGlzdGVuZXI+KGV2ZW50TmFtZTogc3RyaW5nIHwgc3RyaW5nW10sIGxpc3RlbmVyOiBUKSA9PiB7XHJcbiAgICAgICAgdGhpcy5fZXZlbnRMZXZlbFxyXG4gICAgICAgICAgICAuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIHRydWUpXHJcbiAgICAgICAgICAgIC5yZWNlaXZlcnMuYWRkKGxpc3RlbmVyKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGxpc3RlbmVyO1xyXG4gICAgfVxyXG4gICAgb24gPSB0aGlzLnJlY2VpdmU7XHJcblxyXG4gICAgcmVjZWl2ZU9uY2UgPSA8VCBleHRlbmRzIExpc3RlbmVyPihldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBsaXN0ZW5lcjogVCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGxldmVsID0gdGhpcy5fZXZlbnRMZXZlbC5nZXRDaGlsZExldmVsKEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKSwgdHJ1ZSk7XHJcbiAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmFkZChmdW5jdGlvbiBvbmNlKGRhdGEpIHtcclxuICAgICAgICAgICAgbGlzdGVuZXIoZGF0YSk7XHJcbiAgICAgICAgICAgIGxldmVsLnJlY2VpdmVycy5kZWxldGUob25jZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBsaXN0ZW5lcjtcclxuICAgIH1cclxuICAgIG9uY2UgPSB0aGlzLnJlY2VpdmVPbmNlO1xyXG5cclxuICAgIGNhbmNlbCA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdID0gW10sIGxpc3RlbmVyPzogTGlzdGVuZXIpID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIGZhbHNlKTtcclxuICAgICAgICBpZiAobGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgaWYgKGxpc3RlbmVyICE9PSB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICBsZXZlbC5yZWNlaXZlcnMuZGVsZXRlKGxpc3RlbmVyKTtcclxuICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgICBvZmYgPSB0aGlzLmNhbmNlbDtcclxuXHJcbiAgICBjYW5jZWxEZXNjZW5kYW50cyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdID0gW10sIGluY2x1ZGVTZWxmOiBib29sZWFuID0gdHJ1ZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGxldmVsID0gdGhpcy5fZXZlbnRMZXZlbC5nZXRDaGlsZExldmVsKEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKSwgZmFsc2UpO1xyXG4gICAgICAgIGlmIChsZXZlbCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGlmIChpbmNsdWRlU2VsZikgbGV2ZWwucmVjZWl2ZXJzLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIGxldmVsLmNoaWxkcmVuLmNsZWFyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgb2ZmRGVzY2VuZGFudHMgPSB0aGlzLmNhbmNlbERlc2NlbmRhbnRzO1xyXG5cclxuICAgIGNhbmNlbEFuY2VzdG9ycyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdID0gW10sIGluY2x1ZGVTZWxmOiBib29sZWFuID0gdHJ1ZSkgPT4ge1xyXG4gICAgICAgIGxldCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWw7XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgY3VycmVudE5hbWUgb2YgRXZlbnRTcGFjZS5jb252ZXJ0RXZlbnROYW1lVHlwZShldmVudE5hbWUpKSB7XHJcbiAgICAgICAgICAgIGxldmVsLnJlY2VpdmVycy5jbGVhcigpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY3VycmVudExldmVsID0gbGV2ZWwuY2hpbGRyZW4uZ2V0KGN1cnJlbnROYW1lKTtcclxuICAgICAgICAgICAgaWYgKGN1cnJlbnRMZXZlbCAhPT0gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAgICAgbGV2ZWwgPSBjdXJyZW50TGV2ZWw7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChpbmNsdWRlU2VsZikgbGV2ZWwucmVjZWl2ZXJzLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgICBvZmZBbmNlc3RvcnMgPSB0aGlzLmNhbmNlbEFuY2VzdG9ycztcclxuXHJcbiAgICB0cmlnZ2VyID0gKGV2ZW50TmFtZTogc3RyaW5nIHwgc3RyaW5nW10sIGRhdGE/OiBhbnksIGFzeW5jaHJvbm91cz86IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIGZhbHNlKTtcclxuICAgICAgICBpZiAobGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgbGV2ZWwucmVjZWl2ZXJzLmZvckVhY2goaXRlbSA9PiBhc3luY2hyb25vdXMgPyBzZXRUaW1lb3V0KGl0ZW0sIDAsIGRhdGEpIDogaXRlbShkYXRhKSk7XHJcbiAgICB9XHJcbiAgICBzZW5kID0gdGhpcy50cmlnZ2VyO1xyXG5cclxuICAgIHRyaWdnZXJEZXNjZW5kYW50cyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBkYXRhPzogYW55LCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUsIGFzeW5jaHJvbm91cz86IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBjb25zdCBsZXZlbCA9IHRoaXMuX2V2ZW50TGV2ZWwuZ2V0Q2hpbGRMZXZlbChFdmVudFNwYWNlLmNvbnZlcnRFdmVudE5hbWVUeXBlKGV2ZW50TmFtZSksIGZhbHNlKTtcclxuICAgICAgICBpZiAobGV2ZWwgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpZiAoaW5jbHVkZVNlbGYpIGxldmVsLnJlY2VpdmVycy5mb3JFYWNoKGl0ZW0gPT4gYXN5bmNocm9ub3VzID8gc2V0VGltZW91dChpdGVtLCAwLCBkYXRhKSA6IGl0ZW0oZGF0YSkpO1xyXG5cclxuICAgICAgICAgICAgZnVuY3Rpb24gdHJpZ2dlckNoaWxkcmVuKGxldmVsOiBFdmVudExldmVsKSB7XHJcbiAgICAgICAgICAgICAgICBsZXZlbC5yZWNlaXZlcnMuZm9yRWFjaChpdGVtID0+IGFzeW5jaHJvbm91cyA/IHNldFRpbWVvdXQoaXRlbSwgMCwgZGF0YSkgOiBpdGVtKGRhdGEpKTtcclxuICAgICAgICAgICAgICAgIGxldmVsLmNoaWxkcmVuLmZvckVhY2godHJpZ2dlckNoaWxkcmVuKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXZlbC5jaGlsZHJlbi5mb3JFYWNoKHRyaWdnZXJDaGlsZHJlbik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc2VuZERlc2NlbmRhbnRzID0gdGhpcy50cmlnZ2VyRGVzY2VuZGFudHM7XHJcblxyXG4gICAgdHJpZ2dlckFuY2VzdG9ycyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBkYXRhPzogYW55LCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUsIGFzeW5jaHJvbm91cz86IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBsZXQgbGV2ZWwgPSB0aGlzLl9ldmVudExldmVsO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGN1cnJlbnROYW1lIG9mIEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKSkge1xyXG4gICAgICAgICAgICBsZXZlbC5yZWNlaXZlcnMuZm9yRWFjaChpdGVtID0+IGFzeW5jaHJvbm91cyA/IHNldFRpbWVvdXQoaXRlbSwgMCwgZGF0YSkgOiBpdGVtKGRhdGEpKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRMZXZlbCA9IGxldmVsLmNoaWxkcmVuLmdldChjdXJyZW50TmFtZSk7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50TGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgIGxldmVsID0gY3VycmVudExldmVsO1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoaW5jbHVkZVNlbGYpIGxldmVsLnJlY2VpdmVycy5mb3JFYWNoKGl0ZW0gPT4gYXN5bmNocm9ub3VzID8gc2V0VGltZW91dChpdGVtLCAwLCBkYXRhKSA6IGl0ZW0oZGF0YSkpO1xyXG4gICAgfVxyXG4gICAgc2VuZEFuY2VzdG9ycyA9IHRoaXMudHJpZ2dlckFuY2VzdG9ycztcclxuXHJcbiAgICBoYXMgPSAoZXZlbnROYW1lOiBzdHJpbmcgfCBzdHJpbmdbXSwgbGlzdGVuZXI/OiBMaXN0ZW5lcikgPT4ge1xyXG4gICAgICAgIGNvbnN0IGxldmVsID0gdGhpcy5fZXZlbnRMZXZlbC5nZXRDaGlsZExldmVsKEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKSwgZmFsc2UpO1xyXG4gICAgICAgIGlmIChsZXZlbCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGlmIChsaXN0ZW5lciAhPT0gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGxldmVsLnJlY2VpdmVycy5oYXMobGlzdGVuZXIpO1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbGV2ZWwucmVjZWl2ZXJzLnNpemUgPiAwO1xyXG4gICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgaGFzRGVzY2VuZGFudHMgPSAoZXZlbnROYW1lOiBzdHJpbmcgfCBzdHJpbmdbXSwgaW5jbHVkZVNlbGY6IGJvb2xlYW4gPSB0cnVlKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbGV2ZWwgPSB0aGlzLl9ldmVudExldmVsLmdldENoaWxkTGV2ZWwoRXZlbnRTcGFjZS5jb252ZXJ0RXZlbnROYW1lVHlwZShldmVudE5hbWUpLCBmYWxzZSk7XHJcbiAgICAgICAgaWYgKGxldmVsICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgaWYgKGluY2x1ZGVTZWxmICYmIGxldmVsLnJlY2VpdmVycy5zaXplID4gMCkgcmV0dXJuIHRydWU7XHJcblxyXG4gICAgICAgICAgICBmdW5jdGlvbiBjaGVja0NoaWxkcmVuKGxldmVsOiBFdmVudExldmVsKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAobGV2ZWwucmVjZWl2ZXJzLnNpemUgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBsZXZlbC5jaGlsZHJlbi52YWx1ZXMoKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoZWNrQ2hpbGRyZW4oaXRlbSkpIHJldHVybiB0cnVlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBsZXZlbC5jaGlsZHJlbi52YWx1ZXMoKSlcclxuICAgICAgICAgICAgICAgIGlmIChjaGVja0NoaWxkcmVuKGl0ZW0pKSByZXR1cm4gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGhhc0FuY2VzdG9ycyA9IChldmVudE5hbWU6IHN0cmluZyB8IHN0cmluZ1tdLCBpbmNsdWRlU2VsZjogYm9vbGVhbiA9IHRydWUpID0+IHtcclxuICAgICAgICBsZXQgbGV2ZWwgPSB0aGlzLl9ldmVudExldmVsO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGN1cnJlbnROYW1lIG9mIEV2ZW50U3BhY2UuY29udmVydEV2ZW50TmFtZVR5cGUoZXZlbnROYW1lKSkge1xyXG4gICAgICAgICAgICBpZiAobGV2ZWwucmVjZWl2ZXJzLnNpemUgPiAwKSByZXR1cm4gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRMZXZlbCA9IGxldmVsLmNoaWxkcmVuLmdldChjdXJyZW50TmFtZSk7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50TGV2ZWwgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgIGxldmVsID0gY3VycmVudExldmVsO1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoaW5jbHVkZVNlbGYpXHJcbiAgICAgICAgICAgIHJldHVybiBsZXZlbC5yZWNlaXZlcnMuc2l6ZSA+IDA7XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbn0iXX0=
